# سرویس کوتاه‌کننده لینک با ASP.NET Core

## توضیحات پروژه

این پروژه یک سرویس وب API برای کوتاه کردن لینک‌ها (URL Shortener) است که با استفاده از **ASP.NET Core 8** پیاده‌سازی شده است. هدف آن دریافت یک URL طولانی از کاربر، تولید یک کد کوتاه منحصر به فرد (مانند `aB3xY7`)، و ارائه یک لینک کوتاه (مانند `https://localhost:7213/aB3xY7`) است که کاربر را به URL اصلی هدایت می‌کند.

---

## مشخصات پروژه

- **.NET 8 SDK**: برای اجرای پروژه.
- **SQL Server**: برای ذخیره‌سازی داده‌ها (LocalDB یا SQL Server Express قابل استفاده است).
- **Entity Framework**: برای انجام عملیات CRUD در دیتابیس

---

## معماری پروژه

پروژه از معماری لایه‌ای با رعایت اصول SOLID استفاده می‌کند:

- **لایه Controllers**: درخواست‌های HTTP را مدیریت می‌کند.
  - `UrlShortenerController`: شامل endpoint برای کوتاه کردن لینک (`POST /api/UrlShortener/shorten`).
  - `UrlRedirectorController`: هدایت به URL اصلی (`GET api/{shortCode}`).
- **لایه Services**: بیزنس اصلی برنامه مانند تولید کد کوتاه و اعتبارسنجی URL را پیاده‌سازی می‌کند (`IUrlShortenerService`).
- **لایه Repositories**: دسترسی به دیتابیس را مدیریت می‌کند (`IShortUrlRepository`).
- **دیتابیس**: از Entity Framework Core با SQL Server برای ذخیره کدهای کوتاه و URLهای اصلی استفاده شده است.

---

## فرآیند توسعه

1- **راه‌اندازی پروژه**:

- یک پروژه ASP.NET Core Web API با .NET 8 ایجاد شد.

- پکیج‌های مورد نیاز با nuget package manager نصب شدند:

  ```bash
  Microsoft.EntityFrameworkCore.SqlServer
  Microsoft.EntityFrameworkCore.Tools
  ```

2- **مدل داده**:

- مدل `ShortUrl` با سه پراپرتی `Id` (کلید اصلی)، `ShortCode` و `OriginalUrl` تعریف شد.
- مدل `ShortenRequest` به عنوان یک DTO با پراپرتی `OriginalUrl` برای استفاده در کنترلر `UrlShortenerController` و دریافت لینک اصلی تعریف شد.
- از `ApplicationDbContext` برای ارتباط با دیتابیس استفاده شد.

3- **لایه Repository**:

- رابط `IShortUrlRepository` و پیاده‌سازی آن برای عملیات CRUD (ایجاد، خواندن، ذخیره) تعریف شد.
- این لایه از وابستگی مستقیم به دیتابیس جلوگیری می‌کند.

4- **لایه Service**:

- سرویس `UrlShortenerService` برای تولید کد کوتاه تصادفی و اعتبارسنجی URL پیاده‌سازی شد.
- برای تولید کد کوتاه از یک رشته تصادفی 6 کاراکتری استفاده شد که در بخش امتیازی توضیح داده می‌شود.

5- **لایه Controller**:

- کنترلر `UrlShortenerController` برای endpoint `POST /api/UrlShortener/shorten` ایجاد شد.
- کنترلر `UrlRedirectorController` برای endpoint `GET /{shortCode}` پیاده‌سازی شد تا هدایت به URL اصلی انجام شود.

6- **مدیریت خطاها**:

- اعتبارسنجی URL با استفاده از FluentValidation انجام شد تا فقط URLهای معتبر پذیرفته شوند.
- کدهای وضعیت HTTP مناسب (200، 301، 400، 404) برای سناریوهای مختلف پیاده‌سازی شدند.

7- **تست و دیباگ**:

- از Swagger برای تست اولیه استفاده شد.
- یک کالکشن Postman برای تست endpointها ایجاد و در ریپازیتوری قرار گرفت.

---

## اعتبارسنجی با FluentValidation

برای مدیریت بهتر اعتبارسنجی ورودی‌ها، از کتابخانه **FluentValidation** استفاده شده است. این کتابخانه امکان تعریف قوانین اعتبارسنجی به صورت متمرکز و خوانا را فراهم می‌کند.

### پیاده‌سازی

- یک کلاس اعتبارسنجی (`ShortenRequestValidator`) برای مدل `ShortenRequest` ایجاد شد که قوانین زیر را اعمال می‌کند:
  - URL نباید خالی باشد.
  - URL باید یک آدرس معتبر http یا https باشد.
  - URL نمی‌تواند بیش از 2048 کاراکتر باشد.
- به دلیل منسوخ شدن اعتبارسنجی خودکار در نسخه‌های جدیدتر FluentValidation، از اعتبارسنجی دستی در کنترلر استفاده شد.
- اعتبارسنجی در `UrlShortenerController` به صورت دستی با استفاده از `IValidator<ShortenRequest>` انجام می‌شود.
- در صورت خطا، پاسخ JSON با جزئیات خطاها بازگردانده می‌شود.

### مزایا

- جداسازی منطق اعتبارسنجی از بیزینس اصلی برنامه.
- پیام‌های خطای دقیق و قابل تنظیم.
- قابلیت تست و توسعه‌ی آسان.

### نمونه پاسخ خطا

در صورت ارسال URL نامعتبر:

```json
{
  "errors": {
    "LongUrl": ["URL باید یک آدرس معتبر http یا https باشد"]
  }
}
```

---

## پشتیبانی از CancellationToken

برای بهبود مدیریت عملیات ناهمگام، پشتیبانی از `CancellationToken` به پروژه اضافه شد.

### پیاده‌سازی

- متدهای ناهمگام در `IUrlShortenerService` و `IShortUrlRepository` به‌روزرسانی شدند تا `CancellationToken` را بپذیرند.
- کنترلرهای `UrlShortenerController` و `UrlRedirectorController` از `HttpContext.RequestAborted` برای انتقال توکن به لایه‌های سرویس و ریپازیتوری استفاده می‌کنند.
- در سرویس `UrlShortenerService`، توکن برای بررسی لغو عملیات در حلقه تولید کد کوتاه و عملیات دیتابیس استفاده شد.

### مزایا

- امکان لغو عملیات در صورت قطع ارتباط کاربر (مانند بستن مرورگر یا توقف درخواست در Postman).
- صرفه‌جویی در منابع سرور با جلوگیری از اجرای عملیات غیرضروری.
- بهبود مقیاس‌پذیری در سناریوهای پرترافیک.


---

## لاگ‌گیری

برای بهبود قابلیت دیباگ و مانیتورینگ، لاگ‌گیری با استفاده از `ILogger<T>` به پروژه اضافه شد.

### پیاده‌سازی

- لاگ‌گیری در `UrlShortenerController`، `UrlRedirectorController`، `UrlShortenerService` و `ShortUrlRepository` اضافه شد.
- لاگ‌های `Information` برای ثبت درخواست‌ها و عملیات موفق، `Warning` برای خطاها یا موارد ناموفق (مانند URL نامعتبر یا کد کوتاه ناموجود)، و `Error` برای اکسپشن‌ها استفاده شدند.
- سطوح لاگ مختلف برای تمایز بین رویدادها استفاده شد: `LogInformation` برای عملیات عادی، `LogWarning` برای مشکلات، `LogError` برای خطاهای بحرانی، و `LogDebug` برای جزئیات دیباگ.
- پشتیبانی از لغو عملیات (`CancellationToken`) با لاگ‌های مربوطه ادغام شد.
- در `Program.cs`، با استفاده از `AddLogging`، لاگ‌‌ها فقط در کنسول نمایش داده می‌شوند و حداقل سطح لاگ‌گیری هم سطح 1 (LogLevel.Debug) تعیین شد.

### مزایا

- تسهیل دیباگ با ثبت رویدادهای کلیدی مانند تولید کد کوتاه، اعتبارسنجی، و هدایت.
- مانیتورینگ رفتار سیستم در سناریوهای واقعی.
- ثبت اکسپشن‌ها برای تشخیص سریع خطاها.


### سطوح لاگ

- `LogInformation`: برای ثبت عملیات موفق مانند دریافت درخواست و تولید کد کوتاه.
- `LogWarning`: برای مشکلات غیربحرانی مانند خطاهای اعتبارسنجی یا کد کوتاه ناموجود.
- `LogError`: برای اِکسپشن‌ها و خطاهای بحرانی.
- `LogDebug`: برای جزئیات دیباگ مانند تلاش‌های تولید کد کوتاه (فقط با سطح `Debug` قابل مشاهده).

---

## الگوریتم تولید کد کوتاه (بخش امتیازی)

### روش انتخاب شده

- به جای استفاده از شناسه‌های عددی افزایشی (مانند Auto-increment ID) از یک الگوریتم تولید رشته تصادفی استفاده شد.
- کدهای کوتاه 6 کاراکتری از مجموعه کاراکترهای `a-z`, `A-Z`, `0-9` (62 کاراکتر) تولید می‌شوند.

### مزایا

- **غیرقابل پیش‌بینی بودن**: کدها ترتیبی نیستند، بنابراین حدس زدن آن‌ها دشوار است و امنیت بیشتری فراهم می‌کند.
- **سادگی پیاده‌سازی**: نیازی به تبدیل به مبنای خاص نیست.

### معایب

- **احتمال تصادم**: در تعداد زیاد لینک‌ها، احتمال تولید کد تکراری وجود دارد (هرچند با 62^6 ≈ 56 میلیارد امکان، این احتمال کم است).
- **کارایی**: بررسی تصادم در دیتابیس ممکن است در مقیاس بزرگ کند باشد.

### مدیریت تصادم

- اگر کد تولید شده در دیتابیس وجود داشته باشد، یک کد جدید تولید می‌شود تا یکتایی تضمین شود.

---

## مهم:

- مجموعه Postman در فایل `UrlShortenerAPITest.postman_collection.json` در پوشه‌ی docs ارائه شده است و سناریوهای مختلف تست شده است.
